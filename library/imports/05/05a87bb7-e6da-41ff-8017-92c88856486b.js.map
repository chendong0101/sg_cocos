{"version":3,"sources":["assets\\scripts\\defense\\Tower.js"],"names":["cc","Class","Component","properties","vision","faceDir","skill_cd","active","bulletPrefab","type","Prefab","attackAudio","AudioClip","onLoad","node","on","Node","EventType","TOUCH_MOVE","event","opacity","delta","touch","getDelta","x","y","TOUCH_END","index","game","getGridIndex","position","i","j","map","getGridPos","onActive","v2","originPos","log","start","update","dt","cd","scanEnemy","monsters","forEach","enemy","isValid","pos","enemyPos","sub","mag","doAttack","target","audioEngine","playEffect","newBullet","instantiate","group","getParent","addChild","width","getComponent","dir","normalizeSelf","owner"],"mappings":"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","sourceRoot":"/","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://docs.cocos2d-x.org/creator/manual/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] https://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] https://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        vision: 0,\n        faceDir: 1,\n        skill_cd: 0,\n        active: false,\n        bulletPrefab: {\n            default: null,\n            type: cc.Prefab\n        },\n        attackAudio: {\n            default: null,\n            type: cc.AudioClip\n        },\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    onLoad () {\n        // var anim = this.node.getComponent(cc.Animation);\n        // var animState = anim.play();\n        // animState.wrapMode = cc.WrapMode.Normal;\n        // animState.wrapMode = cc.WrapMode.Loop;\n        // animState.repeatCount = Infinity;\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, event => {\n            if (this.active) {\n                return;\n            }\n            this.opacity = 100;\n            var delta = event.touch.getDelta();\n            this.node.x += delta.x;\n            this.node.y += delta.y;\n        }, this.node);\n        this.node.on(cc.Node.EventType.TOUCH_END, () => {\n            if (this.active) {\n                return;\n            }\n            this.opacity = 255;\n            var index = this.game.getGridIndex(this.node.position);\n            var i = index.x;\n            var j = index.y;\n            if (this.game.map[i][j] === 1) {\n                this.node.position = this.game.getGridPos(i, j);\n                this.game.map[i][j] = 2;\n                this.onActive();\n            } else {\n                this.node.position = cc.v2(this.originPos);\n                cc.log(\"origin pos: \" + this.originPos);\n            }\n        }, this.node);\n    },\n\n    onActive () {\n        this.active = true;\n    },\n\n    start () {\n        this.originPos = cc.v2(this.node.position);\n    },\n\n    update (dt) {\n        if (!this.active) {\n            return;\n        }\n        if (this.cd > 0) {\n            this.cd -= dt;\n        }\n        this.scanEnemy();\n    },\n\n    scanEnemy() {\n        if (!this.game) {\n            cc.log(\"game is null\");\n            return;\n        }\n        this.game.monsters.forEach(enemy => {\n            if (!enemy.isValid) {\n                return;\n            }\n            var pos = this.node.position;\n            var enemyPos = enemy.position;\n            if (pos.sub(enemyPos).mag() < this.vision) {\n                this.doAttack(enemy);\n            }\n        });\n    },\n\n    doAttack(target) {\n        if (!this.bulletPrefab) {\n            return;\n        }\n        if (this.cd > 0) {\n            return;\n        }\n        if (this.attackAudio) {\n            cc.audioEngine.playEffect(this.attackAudio, false);\n        }\n        this.cd = this.skill_cd;\n        var newBullet = cc.instantiate(this.bulletPrefab);\n        newBullet.group = 'player';\n        this.node.getParent().addChild(newBullet, 1);\n        var pos = cc.v2(this.node.position.x, this.node.position.y);\n        pos.x = pos.x + this.faceDir * this.node.width / 2;\n        newBullet.position = pos;\n        newBullet.getComponent('Bullet').dir = target.position.sub(this.node.position).normalizeSelf();\n        newBullet.getComponent('Bullet').owner = this;\n    },\n});\n"]}